<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nemo Server - Search</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/animations.css">
  
  <script src="assets/js/api.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/auth.js"></script>
</head>
<body>
  
  <!-- Header -->
  <header class="glass-header">
    <div class="container">
      <div class="flex-between">
        <div class="flex">
          <h1 style="font-size: 1.5rem; margin: 0; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üéôÔ∏è Nemo Server
          </h1>
        </div>
        
        <nav class="nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="search.html" class="nav-link active">Search</a>
          <a href="emotions.html" class="nav-link">Emotions</a>
          <a href="memories.html" class="nav-link">Memories</a>
          <a href="gemma.html" class="nav-link">AI Insights</a>
          <a href="settings.html" class="nav-link">Settings</a>
        </nav>
        
        <div class="flex" style="gap: 1rem; align-items: center;">
          <span id="current-user" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
          <button id="logout-btn" class="glass-button" style="display: none;" title="Logout">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
          </button>
          <button class="glass-button" data-toggle-theme>
            <i data-lucide="moon" style="width: 18px; height: 18px;"></i>
          </button>
          <div id="api-status"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    
    <!-- Hero -->
    <section class="fade-in-up" style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Search Transcripts</h1>
      <p class="text-muted">Find any conversation, word, or phrase across all your transcriptions</p>
    </section>

    <!-- Search Bar -->
    <section class="fade-in-up delay-100" style="margin-bottom: 3rem;">
      <div class="search-bar" style="margin: 0 auto;">
        <i data-lucide="search" class="search-icon"></i>
        <input 
          type="text" 
          class="search-input" 
          placeholder="Search transcripts, speakers, or keywords..."
          id="search-input"
          autofocus
        >
      </div>
    </section>

    <!-- Filters -->
    <section class="fade-in-up delay-200" style="margin-bottom: 2rem;">
      <div style="text-align: center;">
        <div id="filter-chips" style="display: inline-flex; flex-wrap: wrap; gap: 0.5rem; justify-content: center;">
          <span class="chip active" data-filter="all">All Results</span>
          <span class="chip" data-filter="today">Today</span>
          <span class="chip" data-filter="week">This Week</span>
          <span class="chip" data-filter="month">This Month</span>
        </div>
      </div>
    </section>

    <!-- Results -->
    <section class="fade-in-up delay-300">
      <div class="glass-card">
        <h3 id="results-title">Recent Transcripts</h3>
        
        <div id="search-results">
          <!-- Loading -->
          <div id="loading-state">
            <div class="skeleton" style="height: 100px; margin-bottom: 1rem;"></div>
            <div class="skeleton" style="height: 100px; margin-bottom: 1rem;"></div>
            <div class="skeleton" style="height: 100px;"></div>
          </div>
          
          <!-- Empty State -->
          <div id="empty-state" class="hidden" style="text-align: center; padding: 3rem 0;">
            <i data-lucide="search-x" style="width: 64px; height: 64px; color: var(--text-tertiary); margin-bottom: 1rem;"></i>
            <h3>No Results Found</h3>
            <p class="text-muted">Try different keywords or filters</p>
          </div>
          
          <!-- Results Container -->
          <div id="results-container"></div>
        </div>
      </div>
    </section>

  </main>

  <script>
    lucide.createIcons();

    const searchInput = document.getElementById('search-input');
    const resultsContainer = document.getElementById('results-container');
    const loadingState = document.getElementById('loading-state');
    const emptyState = document.getElementById('empty-state');
    const resultsTitle = document.getElementById('results-title');

    let currentQuery = '';
    let currentFilter = 'all';

    // Debounced search
    const performSearch = debounce(async () => {
      const query = searchInput.value.trim();
      currentQuery = query;

      // Show loading
      loadingState.classList.remove('hidden');
      resultsContainer.innerHTML = '';
      emptyState.classList.add('hidden');

      try {
        let results;
        if (query) {
          results = await api.searchTranscripts(query, 50);
          resultsTitle.textContent = `Search Results for "${query}"`;
        } else {
          results = await api.getAllTranscripts(20);
          resultsTitle.textContent = 'Recent Transcripts';
        }

        loadingState.classList.add('hidden');

        if (results && results.results && results.results.length > 0) {
          displayResults(results.results);
        } else {
          emptyState.classList.remove('hidden');
        }
      } catch (error) {
        console.error('Search failed:', error);
        loadingState.classList.add('hidden');
        emptyState.classList.remove('hidden');
        showToast('Error', 'Search failed', 'error');
      }
    }, 500);

    // Display results
    function displayResults(results) {
      resultsContainer.innerHTML = '';

      results.forEach((result, index) => {
        const resultEl = document.createElement('div');
        resultEl.className = 'card fade-in-up';
        resultEl.style.animationDelay = `${index * 50}ms`;
        resultEl.style.marginBottom = '1rem';

        const avatar = createSpeakerAvatar(result.speaker || 'UNKNOWN');
        const emotion = result.emotion ? createEmotionBadge(result.emotion) : '';

        resultEl.innerHTML = `
          <div class="card-header">
            <div style="display: flex; align-items: center; gap: 0.75rem;">
              ${avatar.outerHTML}
              <div>
                <div style="font-weight: 600;">${escapeHTML(result.speaker || 'Unknown')}</div>
                <div class="text-muted" style="font-size: 0.75rem;">${formatTime(result.timestamp)}</div>
              </div>
            </div>
            ${emotion ? emotion.outerHTML : ''}
          </div>
          <div class="card-body">
            ${highlightText(result.text, currentQuery)}
          </div>
          <div class="card-footer">
            <span class="text-muted" style="font-size: 0.875rem;">
              Job ID: ${escapeHTML(result.job_id || 'N/A')}
            </span>
            <button class="btn btn-ghost btn-sm" onclick="viewFullTranscript('${result.job_id}')">
              View Full
            </button>
          </div>
        `;

        resultsContainer.appendChild(resultEl);
      });
    }

    // View full transcript
    function viewFullTranscript(jobId) {
      window.location.href = `transcripts.html?job=${jobId}`;
    }

    // Filter chips
    document.querySelectorAll('[data-filter]').forEach(chip => {
      chip.addEventListener('click', () => {
        document.querySelectorAll('[data-filter]').forEach(c => c.classList.remove('active'));
        chip.classList.add('active');
        currentFilter = chip.dataset.filter;
        performSearch();
      });
    });

    // Search input listener
    searchInput.addEventListener('input', performSearch);

    // Initialize page with authentication
    async function initPage() {
      // Enforce authentication
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;
      
      // Initial load
      performSearch();
    }
    
    // Call on DOM ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', initPage);
    } else {
      initPage();
    }
  </script>

</body>
</html>


