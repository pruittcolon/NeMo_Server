<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Nemo Server - Comprehensive Analysis</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
  
  <script src="https://unpkg.com/lucide@latest"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.js"></script>
  
  <link rel="stylesheet" href="assets/css/main.css">
  <link rel="stylesheet" href="assets/css/components.css">
  <link rel="stylesheet" href="assets/css/animations.css">
  
  <script src="assets/js/api.js"></script>
  <script src="assets/js/app.js"></script>
  <script src="assets/js/auth.js"></script>

  <style>
    .tabs {
      display: flex;
      gap: 0.5rem;
      margin-bottom: 2rem;
      border-bottom: 2px solid var(--border-color);
      padding-bottom: 0;
    }
    .tab {
      padding: 0.75rem 1.5rem;
      background: transparent;
      border: none;
      color: var(--text-secondary);
      cursor: pointer;
      font-size: 0.95rem;
      font-weight: 600;
      transition: all 0.2s;
      border-bottom: 2px solid transparent;
      margin-bottom: -2px;
    }
    .tab:hover {
      color: var(--primary);
    }
    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }
    .tab-content {
      display: none;
    }
    .tab-content.active {
      display: block;
      animation: fadeIn 0.3s ease-in-out;
    }
    .speaker-card {
      padding: 1.5rem;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      cursor: pointer;
      transition: all 0.2s;
    }
    .speaker-card:hover {
      border-color: var(--primary);
      transform: translateY(-2px);
      box-shadow: 0 8px 16px rgba(0,0,0,0.1);
    }
    .speaker-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1));
    }
    .emotion-chip {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 1rem;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      background: var(--glass-bg);
      border: 2px solid var(--border-color);
    }
    .emotion-chip:hover {
      border-color: var(--primary);
    }
    .emotion-chip.selected {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
    }
    .message-card {
      padding: 1rem;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 0.75rem;
      transition: all 0.2s;
    }
    .message-card:hover {
      border-color: var(--primary-light);
    }
    .message-card.selected {
      border-color: var(--primary);
      background: linear-gradient(135deg, rgba(59, 130, 246, 0.05), rgba(147, 51, 234, 0.05));
    }
    .filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      padding: 1rem;
      background: var(--glass-bg);
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 1.5rem;
    }
    .filter-tag {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.5rem 0.75rem;
      background: var(--primary);
      color: white;
      border-radius: 9999px;
      font-size: 0.875rem;
      font-weight: 600;
    }
    .filter-tag button {
      background: transparent;
      border: none;
      color: white;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
    }
  </style>
</head>
<body>
  
  <header class="glass-header">
    <div class="container">
      <div class="flex-between">
        <div class="flex">
          <h1 style="font-size: 1.5rem; margin: 0; background: var(--gradient-primary); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">
            üéôÔ∏è Nemo Server
          </h1>
        </div>
        
        <nav class="nav">
          <a href="index.html" class="nav-link">Dashboard</a>
          <a href="search.html" class="nav-link">Search</a>
          <a href="emotions.html" class="nav-link">Emotions</a>
          <a href="memories.html" class="nav-link">Memories</a>
          <a href="gemma.html" class="nav-link">AI Insights</a>
          <a href="settings.html" class="nav-link">Settings</a>
        </nav>
        
        <div class="flex" style="gap: 1rem; align-items: center;">
          <span id="current-user" style="color: var(--text-secondary); font-size: 0.9rem;"></span>
          <button id="logout-btn" class="glass-button" style="display: none;" title="Logout">
            <i data-lucide="log-out" style="width: 18px; height: 18px;"></i>
          </button>
          <button class="glass-button" data-toggle-theme>
            <i data-lucide="moon" style="width: 18px; height: 18px;"></i>
          </button>
          <div id="api-status"></div>
        </div>
      </div>
    </div>
  </header>

  <main class="container" style="padding-top: 2rem; padding-bottom: 2rem;">
    
    <section class="fade-in-up" style="text-align: center; margin-bottom: 3rem;">
      <h1 style="font-size: 2.5rem; margin-bottom: 1rem;">Comprehensive Analysis</h1>
      <p class="text-muted">Filter by speaker, emotion, and date to run AI-powered analysis</p>
    </section>

    <!-- Active Filters -->
    <div id="active-filters" class="filter-bar" style="display: none;">
      <span style="font-weight: 600; color: var(--text-primary);">Active Filters:</span>
      <div id="filter-tags"></div>
      <button class="btn btn-ghost" onclick="clearAllFilters()" style="margin-left: auto;">
        <i data-lucide="x" style="width: 14px; height: 14px;"></i>
        Clear All
      </button>
    </div>

    <!-- Tabs -->
    <div class="tabs">
      <button class="tab" data-tab="speakers" onclick="switchTab('speakers')">
        <i data-lucide="users" style="width: 16px; height: 16px; display: inline; vertical-align: middle;"></i>
        Speakers
      </button>
      <button class="tab" data-tab="emotions" onclick="switchTab('emotions')">
        <i data-lucide="smile" style="width: 16px; height: 16px; display: inline; vertical-align: middle;"></i>
        Emotions
      </button>
      <button class="tab" data-tab="timeline" onclick="switchTab('timeline')">
        <i data-lucide="calendar" style="width: 16px; height: 16px; display: inline; vertical-align: middle;"></i>
        Timeline
      </button>
      <button class="tab active" data-tab="analysis" onclick="switchTab('analysis')">
        <i data-lucide="brain" style="width: 16px; height: 16px; display: inline; vertical-align: middle;"></i>
        AI Analysis
      </button>
    </div>

    <!-- Tab 1: Speakers -->
    <div id="speakers-tab" class="tab-content">
      <div id="speakers-grid" class="grid grid-3" style="gap: 1rem;">
        <!-- Speaker cards will be inserted here -->
      </div>
      <div id="speakers-loading" class="text-center" style="padding: 3rem;">
        <div class="spinner"></div>
        <p class="text-muted" style="margin-top: 1rem;">Loading speakers...</p>
      </div>
      <div id="speakers-empty" class="text-center" style="padding: 3rem; display: none;">
        <i data-lucide="users" style="width: 64px; height: 64px; color: var(--text-tertiary); margin-bottom: 1rem;"></i>
        <h3>No Speakers Found</h3>
        <p class="text-muted">No speaker data available yet</p>
      </div>
    </div>

    <!-- Tab 2: Emotions -->
    <div id="emotions-tab" class="tab-content">
      <div style="margin-bottom: 2rem;">
        <h3 style="margin-bottom: 1rem;">Filter by Emotion</h3>
        <div id="emotion-chips" style="display: flex; flex-wrap: wrap; gap: 0.75rem;">
          <!-- Emotion chips will be inserted here -->
        </div>
      </div>

      <div class="glass-card">
        <h3 style="margin-bottom: 1.5rem;">Emotion Distribution</h3>
        <canvas id="emotion-chart" style="max-height: 300px;"></canvas>
      </div>
    </div>

    <!-- Tab 3: Timeline -->
    <div id="timeline-tab" class="tab-content">
      <div class="glass-card" style="margin-bottom: 1.5rem;">
        <h3 style="margin-bottom: 1rem;">Date Range</h3>
        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 1rem; align-items: end;">
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">Start Date</label>
            <input type="date" id="start-date" class="input">
          </div>
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600;">End Date</label>
            <input type="date" id="end-date" class="input">
          </div>
          <button class="btn btn-primary" onclick="applyDateFilter()">
            <i data-lucide="filter" style="width: 16px; height: 16px;"></i>
            Apply
          </button>
        </div>
      </div>

      <div class="glass-card">
        <h3 style="margin-bottom: 1.5rem;">Messages</h3>
        <div id="timeline-messages">
          <!-- Message cards will be inserted here -->
        </div>
        <div id="timeline-loading" class="text-center" style="padding: 2rem;">
          <div class="spinner"></div>
          <p class="text-muted" style="margin-top: 1rem;">Loading messages...</p>
        </div>
        <div id="timeline-empty" class="text-center" style="padding: 2rem; display: none;">
          <i data-lucide="inbox" style="width: 48px; height: 48px; color: var(--text-tertiary); margin-bottom: 0.5rem;"></i>
          <p class="text-muted">No messages found</p>
        </div>
      </div>
    </div>

    <!-- Tab 4: AI Analysis -->
    <div id="analysis-tab" class="tab-content active">
      <div class="glass-card" style="max-width: 700px; margin: 0 auto 2rem;">
        <div style="text-align: center; margin-bottom: 2rem;">
          <i data-lucide="brain" style="width: 48px; height: 48px; color: var(--primary); margin-bottom: 1rem;"></i>
          <h3 style="margin-bottom: 0.5rem;">Run Comprehensive Analysis</h3>
          <p class="text-muted">
            Gemma AI will analyze conversations for patterns, emotional trends, and insights
          </p>
        </div>
        
        <div style="display: grid; gap: 1.5rem;">
          <!-- Speaker Dropdown -->
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">
              <i data-lucide="user" style="width: 14px; height: 14px; vertical-align: middle;"></i>
              Speaker
            </label>
            <select id="analysis-speaker" class="form-input" onchange="updateAvailableCount()" style="width: 100%; padding: 0.75rem; background: #1e293b; border: 2px solid var(--primary); border-radius: var(--radius); color: white; font-size: 1rem; cursor: pointer;">
              <option value="" style="background: #1e293b; color: white; padding: 0.5rem;">All Speakers</option>
            </select>
          </div>
          
          <!-- Emotion Dropdown (Single Selection) -->
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">
              <i data-lucide="heart" style="width: 14px; height: 14px; vertical-align: middle;"></i>
              Emotion (Single Only)
            </label>
            <select id="analysis-emotion" class="form-input" onchange="updateAvailableCount()" style="width: 100%; padding: 0.75rem; background: #1e293b; border: 2px solid var(--primary); border-radius: var(--radius); color: white; font-size: 1rem; cursor: pointer;">
              <option value="" style="background: #1e293b; color: white; padding: 0.5rem;">All Emotions (Sequential)</option>
              <option value="anger" style="background: #1e293b; color: white; padding: 0.5rem;">üò† Anger</option>
              <option value="disgust" style="background: #1e293b; color: white; padding: 0.5rem;">ü§¢ Disgust</option>
              <option value="fear" style="background: #1e293b; color: white; padding: 0.5rem;">üò® Fear</option>
              <option value="joy" style="background: #1e293b; color: white; padding: 0.5rem;">üòä Joy</option>
              <option value="neutral" style="background: #1e293b; color: white; padding: 0.5rem;">üòê Neutral</option>
              <option value="sadness" style="background: #1e293b; color: white; padding: 0.5rem;">üò¢ Sadness</option>
              <option value="surprise" style="background: #1e293b; color: white; padding: 0.5rem;">üò≤ Surprise</option>
            </select>
            <small class="text-muted" style="display: block; margin-top: 0.5rem; font-size: 0.85rem;">
              ‚ö†Ô∏è Leave empty to analyze all emotions one by one
            </small>
          </div>
          
          <!-- Available Count Display -->
          <div id="available-count" style="display: none; padding: 1rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1)); border: 2px solid var(--primary); border-radius: var(--radius); text-align: center;">
            <div style="font-size: 0.9rem; color: var(--text-secondary); margin-bottom: 0.25rem;">Available Transcripts</div>
            <div style="font-size: 2rem; font-weight: 700; color: var(--primary);" id="available-count-number">0</div>
            <div style="font-size: 0.85rem; color: var(--text-muted); margin-top: 0.25rem;" id="available-count-description">Select speaker/emotion to see count</div>
          </div>
          
          <!-- Date Range -->
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">
                <i data-lucide="calendar" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                Start Date
              </label>
              <input type="date" id="analysis-start-date" class="form-input" onchange="updateAvailableCount()" style="width: 100%; padding: 0.75rem; background: #1e293b; border: 2px solid var(--border-color); border-radius: var(--radius); color: white; cursor: pointer;">
            </div>
            <div>
              <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">
                <i data-lucide="calendar" style="width: 14px; height: 14px; vertical-align: middle;"></i>
                End Date
              </label>
              <input type="date" id="analysis-end-date" class="form-input" onchange="updateAvailableCount()" style="width: 100%; padding: 0.75rem; background: #1e293b; border: 2px solid var(--border-color); border-radius: var(--radius); color: white; cursor: pointer;">
            </div>
          </div>
          
          <!-- Limit -->
          <div>
            <label style="display: block; margin-bottom: 0.5rem; font-weight: 600; font-size: 0.95rem;">
              <i data-lucide="hash" style="width: 14px; height: 14px; vertical-align: middle;"></i>
              Samples per Emotion
            </label>
            <input type="number" id="analysis-limit" class="form-input" value="5" min="1" max="20" style="width: 100%; padding: 0.75rem; background: #1e293b; border: 2px solid var(--border-color); border-radius: var(--radius); color: white; font-size: 1rem; cursor: pointer;">
            <small class="text-muted" style="display: block; margin-top: 0.5rem; font-size: 0.85rem;">
              Number of recent transcripts to analyze per emotion (1-20)
            </small>
          </div>
          
          <button class="btn btn-primary" onclick="runAnalysis()" id="analyze-button" style="font-size: 1.1rem; padding: 1rem; width: 100%; display: flex; align-items: center; justify-content: center; gap: 0.75rem;">
            <i data-lucide="zap" style="width: 20px; height: 20px;"></i>
            Run Analysis
          </button>
        </div>
      </div>

      <div id="analysis-progress" class="glass-card" style="display: none; text-align: center; padding: 2rem;">
        <div class="spinner" style="margin-bottom: 1rem;"></div>
        <h4 id="progress-status">Analyzing conversations...</h4>
        <p class="text-muted" id="progress-message">This may take a moment</p>
        
        <!-- LIVE PROMPT VIEWER -->
        <div id="live-viewer" style="display: none; margin-top: 2rem; text-align: left; max-width: 900px; margin-left: auto; margin-right: auto;">
          <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem;">
            <h3 id="live-title" style="margin: 0;">Prompt 1 of 50</h3>
            <div style="display: flex; gap: 0.5rem;">
              <button id="btn-prev" class="btn btn-secondary" style="padding: 0.5rem 1rem;">‚Üê Prev</button>
              <button id="btn-current" class="btn btn-primary" style="padding: 0.5rem 1rem;">Current</button>
              <button id="btn-next" class="btn btn-secondary" style="padding: 0.5rem 1rem;">Next ‚Üí</button>
            </div>
          </div>
          
          <div id="live-content" style="padding: 1.5rem; background: var(--glass-bg); border: 2px solid var(--primary); border-radius: var(--radius);">
            <!-- Dynamic content here -->
          </div>
        </div>
      </div>

      <div id="analysis-results" class="glass-card" style="display: none;">
        <h3 style="margin-bottom: 1.5rem;">Analysis Results</h3>
        <div id="analysis-content"></div>
      </div>
    </div>

  </main>

  <script>
    lucide.createIcons();

    // Global state
    let currentTab = 'analysis';
    let selectedSpeakers = [];
    let selectedEmotions = [];
    let startDate = null;
    let endDate = null;
    let allSpeakers = [];
    let allMessages = [];
    let emotionChart = null;

    // Live viewer state
    let livePrompts = [];
    let currentPromptIndex = -1;  // -1 means "live" mode
    let autoAdvanceTimer = null;
    
    // Initialize live viewer
    function initLiveViewer() {
      document.getElementById('btn-prev').addEventListener('click', () => {
        if (currentPromptIndex > 0) {
          currentPromptIndex--;
          renderLivePrompt();
        }
      });
      
      document.getElementById('btn-next').addEventListener('click', () => {
        if (currentPromptIndex < livePrompts.length - 1) {
          currentPromptIndex++;
          renderLivePrompt();
        }
      });
      
      document.getElementById('btn-current').addEventListener('click', () => {
        currentPromptIndex = -1;
        renderLivePrompt();
      });
    }
    
    // Render a specific prompt or "current" live one
    function renderLivePrompt() {
      const liveContent = document.getElementById('live-content');
      const liveTitle = document.getElementById('live-title');
      
      let prompt;
      if (currentPromptIndex === -1) {
        // Show most recent
        prompt = livePrompts[livePrompts.length - 1];
        liveTitle.textContent = `Current: Prompt ${livePrompts.length} of ${prompt?.total || '?'}`;
      } else {
        prompt = livePrompts[currentPromptIndex];
        liveTitle.textContent = `Prompt ${currentPromptIndex + 1} of ${livePrompts.length}`;
      }
      
      if (!prompt) return;
      
      // Format context
      const contextHTML = prompt.context?.map(stmt => 
        `<div style="padding: 0.5rem; background: rgba(255,255,255,0.05); border-left: 2px solid var(--border-color); margin-bottom: 0.25rem; font-size: 0.9rem;">${stmt}</div>`
      ).join('') || '<p class="text-muted">No context</p>';
      
      // Status indicator
      let statusBadge = '';
      if (prompt.status === 'preparing') {
        statusBadge = '<span class="badge" style="background: var(--warning);">Preparing...</span>';
      } else if (prompt.status === 'sent') {
        statusBadge = '<span class="badge" style="background: var(--info);">Sent to Gemma...</span>';
      } else if (prompt.status === 'responded') {
        statusBadge = '<span class="badge" style="background: var(--success);">‚úì Responded</span>';
      }
      
      liveContent.innerHTML = `
        <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
          <h3 style="margin: 0; text-transform: capitalize;">${prompt.emotion}</h3>
          ${statusBadge}
        </div>
        
        <div style="margin-bottom: 1rem;">
          <h4 style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 0.5rem;">CONTEXT (Previous statements):</h4>
          ${contextHTML}
        </div>
        
        <div style="margin-bottom: 1rem;">
          <h4 style="font-size: 0.85rem; color: var(--primary); margin-bottom: 0.5rem;">ANALYZE THIS ONE BELOW:</h4>
          <div style="padding: 0.75rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.15), rgba(147, 51, 234, 0.15)); border: 2px solid var(--primary); border-radius: 4px;">
            ${prompt.target || 'N/A'}
          </div>
        </div>
        
        ${prompt.response ? `
          <div>
            <h4 style="font-size: 0.85rem; color: var(--success); margin-bottom: 0.5rem;">GEMMA'S RESPONSE:</h4>
            <div style="padding: 0.75rem; background: rgba(34, 197, 94, 0.1); border: 1px solid var(--success); border-radius: 4px;">
              <pre style="white-space: pre-wrap; margin: 0; font-family: inherit; line-height: 1.5; font-size: 0.95rem;">${prompt.response}</pre>
            </div>
          </div>
        ` : '<p class="text-muted" style="text-align: center; padding: 1rem;"><em>Waiting for Gemma response...</em></p>'}
      `;
    }
    
    // Handle live prompt updates from WebSocket
    function handleLivePrompt(data) {
      const liveViewer = document.getElementById('live-viewer');
      
      // Show viewer on first prompt
      if (livePrompts.length === 0) {
        liveViewer.style.display = 'block';
      }
      
      // Check if this prompt already exists (update) or is new
      const existingIndex = livePrompts.findIndex(p => p.index === data.index);
      if (existingIndex >= 0) {
        livePrompts[existingIndex] = data;
      } else {
        livePrompts.push(data);
      }
      
      // If in "live" mode, auto-render
      if (currentPromptIndex === -1) {
        renderLivePrompt();
        
        // If status is "responded", show for 5 seconds then clear for next
        if (data.status === 'responded') {
          clearTimeout(autoAdvanceTimer);
          autoAdvanceTimer = setTimeout(() => {
            // Don't clear, just wait for next prompt
          }, 5000);
        }
      }
    }

    // Initialize
    async function init() {
      // Enforce authentication
      const authenticated = await Auth.init({ requireAuth: true });
      if (!authenticated) return;
      
      // Initialize live viewer
      initLiveViewer();
      
      // Load speakers for dropdown
      await loadSpeakersForDropdown();
      
      // Parse URL parameters
      const params = new URLSearchParams(window.location.search);
      const speakerParam = params.get('speaker');
      const emotionParam = params.get('emotion');

      if (speakerParam) {
        selectedSpeakers = [speakerParam];
        document.getElementById('analysis-speaker').value = speakerParam;
      }
      if (emotionParam) {
        selectedEmotions = [emotionParam];
        document.getElementById('analysis-emotion').value = emotionParam;
      }

      // Load initial data
      await loadSpeakers();
      await loadEmotionStats();
      await loadMessages();

      updateFilterBar();
    }
    
    // Load speakers for dropdown
    async function loadSpeakersForDropdown() {
      try {
        const speakers = await api.listSpeakers();
        const dropdown = document.getElementById('analysis-speaker');
        
        speakers.forEach(speaker => {
          const option = document.createElement('option');
          option.value = speaker.speaker_id;
          option.textContent = `${speaker.speaker_id} (${speaker.total_segments} segments)`;
          option.style.background = '#1e293b';
          option.style.color = 'white';
          option.style.padding = '0.5rem';
          dropdown.appendChild(option);
        });
      } catch (error) {
        console.error('[INIT] Failed to load speakers:', error);
      }
    }
    
    // Update available transcript count
    async function updateAvailableCount() {
      const speaker = document.getElementById('analysis-speaker').value;
      const emotion = document.getElementById('analysis-emotion').value;
      const startDate = document.getElementById('analysis-start-date').value;
      const endDate = document.getElementById('analysis-end-date').value;
      
      const countBox = document.getElementById('available-count');
      const countNumber = document.getElementById('available-count-number');
      const countDesc = document.getElementById('available-count-description');
      
      // If nothing selected, hide
      if (!speaker && !emotion && !startDate && !endDate) {
        countBox.style.display = 'none';
        return;
      }
      
      try {
        // Build query parameters
        const params = new URLSearchParams();
        if (speaker) params.append('speaker', speaker);
        if (emotion) params.append('emotion', emotion);
        if (startDate) params.append('start_date', startDate);
        if (endDate) params.append('end_date', endDate);
        
        // Fetch count from backend
        const response = await fetch(`/memory/count?${params}`);
        
        if (!response.ok) {
          throw new Error('Failed to fetch count');
        }
        
        const data = await response.json();
        const count = data.count || 0;
        
        // Update display
        countBox.style.display = 'block';
        countNumber.textContent = count;
        
        // Build description
        let desc = '';
        if (speaker && emotion) {
          desc = `${speaker} √ó ${emotion}`;
        } else if (speaker) {
          desc = `${speaker} (all emotions)`;
        } else if (emotion) {
          desc = `${emotion} (all speakers)`;
        } else if (startDate || endDate) {
          desc = 'filtered by date';
        }
        
        if (count === 0) {
          countNumber.style.color = 'var(--error)';
          countDesc.textContent = `‚ö†Ô∏è No transcripts found for ${desc}`;
        } else if (count < 5) {
          countNumber.style.color = 'var(--warning)';
          countDesc.textContent = `‚ö†Ô∏è Only ${count} available for ${desc}`;
        } else {
          countNumber.style.color = 'var(--success)';
          countDesc.textContent = `‚úì ${desc}`;
        }
        
      } catch (error) {
        console.error('[COUNT] Failed to fetch count:', error);
        countBox.style.display = 'block';
        countNumber.textContent = '?';
        countNumber.style.color = 'var(--text-secondary)';
        countDesc.textContent = 'Unable to fetch count';
      }
    }

    // Tab switching
    function switchTab(tabName) {
      currentTab = tabName;
      
      // Update tab buttons
      document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
      });
      document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
      
      // Update tab content
      document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
      });
      document.getElementById(`${tabName}-tab`).classList.add('active');
      
      lucide.createIcons();
    }

    // Load speakers
    async function loadSpeakers() {
      const loading = document.getElementById('speakers-loading');
      const grid = document.getElementById('speakers-grid');
      const empty = document.getElementById('speakers-empty');
      
      try {
        allSpeakers = await api.listSpeakers();
        
        loading.style.display = 'none';
        
        if (allSpeakers.length === 0) {
          empty.style.display = 'block';
          return;
        }
        
        grid.innerHTML = '';
        allSpeakers.forEach(speaker => {
          const card = document.createElement('div');
          card.className = 'speaker-card';
          if (selectedSpeakers.includes(speaker.speaker_id)) {
            card.classList.add('selected');
          }
          
          const emotionTags = speaker.top_emotions.map(e => 
            `<span class="chip" style="font-size: 0.75rem;">${e.emotion} (${e.count})</span>`
          ).join(' ');
          
          card.innerHTML = `
            <div style="display: flex; align-items: center; gap: 1rem; margin-bottom: 1rem;">
              <i data-lucide="user" style="width: 32px; height: 32px; color: var(--primary);"></i>
              <div>
                <h4 style="margin: 0;">${speaker.speaker_id}</h4>
                <p class="text-muted" style="margin: 0; font-size: 0.875rem;">${speaker.total_messages} messages</p>
              </div>
            </div>
            <div style="display: flex; flex-wrap: wrap; gap: 0.5rem; margin-bottom: 0.5rem;">
              ${emotionTags}
            </div>
            <p class="text-muted" style="font-size: 0.75rem; margin: 0;">
              Last active: ${speaker.last_active ? new Date(speaker.last_active).toLocaleDateString() : 'N/A'}
            </p>
          `;
          
          card.onclick = () => toggleSpeaker(speaker.speaker_id);
          grid.appendChild(card);
        });
        
        lucide.createIcons();
      } catch (error) {
        console.error('[ANALYSIS] Error loading speakers:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
      }
    }

    // Load emotion stats
    async function loadEmotionStats() {
      try {
        const stats = await api.getEmotionStats(startDate, endDate);
        
        // Create emotion chips
        const chipsContainer = document.getElementById('emotion-chips');
        chipsContainer.innerHTML = '';
        
        stats.emotions.forEach(emotion => {
          const chip = document.createElement('div');
          chip.className = 'emotion-chip';
          if (selectedEmotions.includes(emotion.emotion)) {
            chip.classList.add('selected');
          }
          
          chip.innerHTML = `
            <i data-lucide="circle" style="width: 12px; height: 12px;"></i>
            <span>${emotion.emotion}</span>
            <span class="badge">${emotion.count}</span>
          `;
          
          chip.onclick = () => toggleEmotion(emotion.emotion);
          chipsContainer.appendChild(chip);
        });
        
        // Create chart
        const ctx = document.getElementById('emotion-chart').getContext('2d');
        
        if (emotionChart) {
          emotionChart.destroy();
        }
        
        emotionChart = new Chart(ctx, {
          type: 'doughnut',
          data: {
            labels: stats.emotions.map(e => e.emotion),
            datasets: [{
              data: stats.emotions.map(e => e.count),
              backgroundColor: [
                'rgba(59, 130, 246, 0.8)',
                'rgba(147, 51, 234, 0.8)',
                'rgba(236, 72, 153, 0.8)',
                'rgba(251, 146, 60, 0.8)',
                'rgba(34, 197, 94, 0.8)',
                'rgba(234, 179, 8, 0.8)',
                'rgba(239, 68, 68, 0.8)',
              ]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: {
                position: 'right'
              }
            }
          }
        });
        
        lucide.createIcons();
      } catch (error) {
        console.error('[ANALYSIS] Error loading emotion stats:', error);
      }
    }

    // Load messages
    async function loadMessages() {
      const loading = document.getElementById('timeline-loading');
      const container = document.getElementById('timeline-messages');
      const empty = document.getElementById('timeline-empty');
      
      loading.style.display = 'block';
      empty.style.display = 'none';
      container.innerHTML = '';
      
      try {
        // Fetch messages based on filters
        let messages = await api.getAllMemories(100);
        
        // Apply filters
        if (selectedSpeakers.length > 0) {
          messages = messages.filter(m => selectedSpeakers.includes(m.speaker));
        }
        if (selectedEmotions.length > 0) {
          messages = messages.filter(m => selectedEmotions.includes(m.emotion));
        }
        if (startDate) {
          messages = messages.filter(m => m.created_at >= startDate);
        }
        if (endDate) {
          messages = messages.filter(m => m.created_at <= endDate);
        }
        
        allMessages = messages;
        
        loading.style.display = 'none';
        
        if (messages.length === 0) {
          empty.style.display = 'block';
          return;
        }
        
        messages.forEach(msg => {
          const card = document.createElement('div');
          card.className = 'message-card';
          
          card.innerHTML = `
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 0.5rem;">
              <div style="display: flex; gap: 0.5rem;">
                <span class="badge">${msg.speaker || 'Unknown'}</span>
                <span class="chip" style="font-size: 0.75rem;">${msg.emotion || 'neutral'}</span>
              </div>
              <span class="text-muted" style="font-size: 0.75rem;">
                ${msg.created_at ? new Date(msg.created_at).toLocaleString() : ''}
              </span>
            </div>
            <p style="margin: 0;">${msg.content || msg.text}</p>
          `;
          
          container.appendChild(card);
        });
        
        lucide.createIcons();
      } catch (error) {
        console.error('[ANALYSIS] Error loading messages:', error);
        loading.style.display = 'none';
        empty.style.display = 'block';
      }
    }

    // Toggle speaker selection
    function toggleSpeaker(speakerId) {
      const idx = selectedSpeakers.indexOf(speakerId);
      if (idx === -1) {
        selectedSpeakers.push(speakerId);
      } else {
        selectedSpeakers.splice(idx, 1);
      }
      
      updateFilterBar();
      loadSpeakers();
      loadMessages();
    }

    // Toggle emotion selection
    function toggleEmotion(emotion) {
      const idx = selectedEmotions.indexOf(emotion);
      if (idx === -1) {
        selectedEmotions.push(emotion);
      } else {
        selectedEmotions.splice(idx, 1);
      }
      
      updateFilterBar();
      
      // Update chips
      document.querySelectorAll('.emotion-chip').forEach(chip => {
        const emotionText = chip.querySelector('span').textContent;
        if (selectedEmotions.includes(emotionText)) {
          chip.classList.add('selected');
        } else {
          chip.classList.remove('selected');
        }
      });
      
      loadMessages();
    }

    // Apply date filter
    function applyDateFilter() {
      startDate = document.getElementById('start-date').value;
      endDate = document.getElementById('end-date').value;
      
      updateFilterBar();
      loadEmotionStats();
      loadMessages();
      
      showToast('Success', 'Date filter applied', 'success');
    }

    // Update filter bar
    function updateFilterBar() {
      const filterBar = document.getElementById('active-filters');
      const tagsContainer = document.getElementById('filter-tags');
      
      const hasFilters = selectedSpeakers.length > 0 || selectedEmotions.length > 0 || startDate || endDate;
      
      if (!hasFilters) {
        filterBar.style.display = 'none';
        return;
      }
      
      filterBar.style.display = 'flex';
      tagsContainer.innerHTML = '';
      
      selectedSpeakers.forEach(speaker => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `
          Speaker: ${speaker}
          <button onclick="toggleSpeaker('${speaker}')">
            <i data-lucide="x" style="width: 14px; height: 14px;"></i>
          </button>
        `;
        tagsContainer.appendChild(tag);
      });
      
      selectedEmotions.forEach(emotion => {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `
          Emotion: ${emotion}
          <button onclick="toggleEmotion('${emotion}')">
            <i data-lucide="x" style="width: 14px; height: 14px;"></i>
          </button>
        `;
        tagsContainer.appendChild(tag);
      });
      
      if (startDate) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `
          From: ${startDate}
          <button onclick="clearStartDate()">
            <i data-lucide="x" style="width: 14px; height: 14px;"></i>
          </button>
        `;
        tagsContainer.appendChild(tag);
      }
      
      if (endDate) {
        const tag = document.createElement('div');
        tag.className = 'filter-tag';
        tag.innerHTML = `
          To: ${endDate}
          <button onclick="clearEndDate()">
            <i data-lucide="x" style="width: 14px; height: 14px;"></i>
          </button>
        `;
        tagsContainer.appendChild(tag);
      }
      
      lucide.createIcons();
    }

    // Clear filters
    function clearAllFilters() {
      selectedSpeakers = [];
      selectedEmotions = [];
      startDate = null;
      endDate = null;
      document.getElementById('start-date').value = '';
      document.getElementById('end-date').value = '';
      
      updateFilterBar();
      loadSpeakers();
      loadEmotionStats();
      loadMessages();
    }

    function clearStartDate() {
      startDate = null;
      document.getElementById('start-date').value = '';
      updateFilterBar();
      loadEmotionStats();
      loadMessages();
    }

    function clearEndDate() {
      endDate = null;
      document.getElementById('end-date').value = '';
      updateFilterBar();
      loadEmotionStats();
      loadMessages();
    }

    // Run Gemma analysis
    async function runAnalysis() {
      const button = document.getElementById('analyze-button');
      const progress = document.getElementById('analysis-progress');
      const results = document.getElementById('analysis-results');
      const liveViewer = document.getElementById('live-viewer');
      
      // Get values from dropdowns
      const speaker = document.getElementById('analysis-speaker').value;
      const emotion = document.getElementById('analysis-emotion').value;
      const startDate = document.getElementById('analysis-start-date').value;
      const endDate = document.getElementById('analysis-end-date').value;
      const limit = parseInt(document.getElementById('analysis-limit').value) || 5;
      
      // Validation
      if (limit < 1 || limit > 20) {
        showToast('Error', 'Limit must be between 1 and 20', 'error');
        return;
      }
      
      // Reset live viewer state
      livePrompts = [];
      currentPromptIndex = -1;
      clearTimeout(autoAdvanceTimer);
      liveViewer.style.display = 'none';
      
      button.disabled = true;
      progress.style.display = 'block';
      results.style.display = 'none';
      
      try {
        // Connect to WebSocket for live updates
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${wsProtocol}//${window.location.host}/ws/gemma`;
        const gemmaWs = new WebSocket(wsUrl);
        
        gemmaWs.onopen = () => {
          console.log('[WS] Connected to Gemma WebSocket');
        };
        
        gemmaWs.onerror = (error) => {
          console.error('[WS] WebSocket error:', error);
        };
        
        // Build filters
        const filters = {
          speakers: speaker ? [speaker] : null,
          emotions: emotion ? [emotion] : null,
          start_date: startDate || null,
          end_date: endDate || null,
          limit_per_emotion: limit
        };
        
        console.log('[ANALYSIS] Submitting with filters:', filters);
        
        // Submit analysis job
        const response = await api.analyzeMemories(filters);
        
        console.log('[ANALYSIS] Submitted job:', response.job_id);
        
        const jobId = response.job_id;
        
        // Handle WebSocket messages
        gemmaWs.onmessage = (event) => {
          const data = JSON.parse(event.data);
          
          if (data.job_id === jobId) {
            // Update progress
            if (data.message) {
              document.getElementById('progress-message').textContent = data.message;
            }
            
            // Handle live prompt updates
            if (data.live_prompt) {
              handleLivePrompt(data.live_prompt);
            }
            
            // Handle completion
            if (data.status === 'completed' && data.result) {
              gemmaWs.close();
              displayAnalysisResults(data.result);
              progress.style.display = 'none';
              liveViewer.style.display = 'none';
              results.style.display = 'block';
              button.disabled = false;
              showToast('Success', 'Analysis complete!', 'success');
            } else if (data.status === 'failed') {
              gemmaWs.close();
              throw new Error(data.error_message || 'Analysis failed');
            }
          }
        };
        
      } catch (error) {
        console.error('[ANALYSIS] Error:', error);
        showToast('Error', error.message || 'Analysis failed', 'error');
        progress.style.display = 'none';
        button.disabled = false;
      }
    }

    // Display analysis results
    function displayAnalysisResults(result) {
      const container = document.getElementById('analysis-content');
      
      // Check if multi-stage analysis with individual analyses
      if (result.individual_analyses && result.meta_analysis) {
        // Build individual emotion cards
        let individualHTML = '';
        result.individual_analyses.forEach(analysis => {
          // Format context statements
          const contextHTML = analysis.context_statements.map(stmt => 
            `<div style="padding: 0.75rem; background: var(--glass-bg); border-left: 3px solid var(--border-color); margin-bottom: 0.5rem;">
              ${stmt}
            </div>`
          ).join('');
          
          individualHTML += `
            <div style="padding: 1.5rem; background: var(--glass-bg); border: 2px solid var(--border-color); border-radius: var(--radius); margin-bottom: 1.5rem;">
              <div style="display: flex; align-items: center; gap: 0.75rem; margin-bottom: 1rem;">
                <i data-lucide="circle" style="width: 20px; height: 20px; color: var(--primary);"></i>
                <h3 style="margin: 0; text-transform: capitalize;">${analysis.emotion}</h3>
                <span class="badge">${analysis.sample_count} samples</span>
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem; color: var(--text-secondary); font-size: 0.9rem;">
                  <i data-lucide="arrow-up" style="width: 14px; height: 14px;"></i>
                  CONTEXT (Previous statements):
                </h4>
                ${contextHTML || '<p class="text-muted">No prior context</p>'}
              </div>
              
              <div style="margin-bottom: 1.5rem;">
                <h4 style="margin-bottom: 0.75rem; color: var(--primary); font-size: 0.9rem;">
                  <i data-lucide="target" style="width: 14px; height: 14px;"></i>
                  ANALYZE THIS ONE BELOW:
                </h4>
                <div style="padding: 1rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1)); border: 2px solid var(--primary); border-radius: var(--radius);">
                  ${analysis.target_statement}
                </div>
              </div>
              
              <div>
                <h4 style="margin-bottom: 0.75rem; color: var(--success); font-size: 0.9rem;">
                  <i data-lucide="message-circle" style="width: 14px; height: 14px;"></i>
                  GEMMA'S RESPONSE:
                </h4>
                <div style="padding: 1rem; background: var(--glass-bg); border: 1px solid var(--success); border-radius: var(--radius);">
                  <pre style="white-space: pre-wrap; margin: 0; font-family: inherit; line-height: 1.6;">${analysis.gemma_response}</pre>
                </div>
              </div>
            </div>
          `;
        });
        
        // Display with individual analyses THEN meta-analysis
        container.innerHTML = `
          <div style="padding: 1.5rem; background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 51, 234, 0.1)); border: 2px solid var(--primary); border-radius: var(--radius); margin-bottom: 2rem;">
            <h4 style="margin-bottom: 1rem;">
              <i data-lucide="zap" style="width: 20px; height: 20px; vertical-align: middle;"></i>
              Analysis Summary
            </h4>
            <p style="margin-bottom: 0.5rem;"><strong>${result.summary}</strong></p>
            <div style="display: flex; gap: 1rem; flex-wrap: wrap; margin-top: 0.75rem;">
              <span class="chip" style="font-size: 0.75rem;">
                <i data-lucide="layers" style="width: 12px; height: 12px;"></i>
                ${result.total_emotions} emotions
              </span>
              <span class="chip" style="font-size: 0.75rem;">
                <i data-lucide="message-square" style="width: 12px; height: 12px;"></i>
                ${result.total_samples} samples
              </span>
              <span class="chip" style="font-size: 0.75rem;">
                <i data-lucide="clock" style="width: 12px; height: 12px;"></i>
                ${result.processing_time_seconds}s (${result.avg_time_per_emotion_seconds}s/emotion)
              </span>
            </div>
          </div>
          
          <div style="margin-bottom: 2rem;">
            <h2 style="margin-bottom: 1.5rem;">
              <i data-lucide="list" style="width: 24px; height: 24px; vertical-align: middle;"></i>
              Individual Emotion Analyses
            </h2>
            ${individualHTML}
          </div>
          
          <div style="padding: 2rem; background: var(--glass-bg); border: 2px solid var(--primary); border-radius: var(--radius);">
            <h2 style="margin-bottom: 1.5rem;">
              <i data-lucide="brain" style="width: 28px; height: 28px; vertical-align: middle;"></i>
              Cross-Emotional Meta-Analysis
            </h2>
            <p style="white-space: pre-wrap; line-height: 1.8; font-size: 1.05rem;">${result.meta_analysis}</p>
          </div>
        `;
      } else if (result.meta_analysis) {
        // Fallback: meta-analysis only
        container.innerHTML = `
          <div style="padding: 2rem; background: var(--glass-bg); border: 2px solid var(--primary); border-radius: var(--radius);">
            <h3 style="margin-bottom: 1.5rem;">
              <i data-lucide="brain" style="width: 24px; height: 24px; vertical-align: middle;"></i>
              Cross-Emotional Analysis
            </h3>
            <p style="white-space: pre-wrap; line-height: 1.8; font-size: 1.05rem;">${result.meta_analysis}</p>
          </div>
        `;
      } else {
        // Display simple analysis (fallback)
        container.innerHTML = `
          <div style="padding: 1.5rem; background: var(--glass-bg); border-radius: var(--radius); margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">
              <i data-lucide="target" style="width: 20px; height: 20px; vertical-align: middle;"></i>
              Summary
            </h4>
            <p style="white-space: pre-wrap;">${result.summary || 'No summary available'}</p>
          </div>
          
          ${result.patterns ? `
          <div style="padding: 1.5rem; background: var(--glass-bg); border-radius: var(--radius); margin-bottom: 1.5rem;">
            <h4 style="margin-bottom: 1rem;">
              <i data-lucide="trending-up" style="width: 20px; height: 20px; vertical-align: middle;"></i>
              Detected Patterns
            </h4>
            <p style="white-space: pre-wrap;">${result.patterns}</p>
          </div>
          ` : ''}
          
          ${result.insights ? `
          <div style="padding: 1.5rem; background: var(--glass-bg); border-radius: var(--radius);">
            <h4 style="margin-bottom: 1rem;">
              <i data-lucide="lightbulb" style="width: 20px; height: 20px; vertical-align: middle;"></i>
              Key Insights
            </h4>
            <p style="white-space: pre-wrap;">${result.insights}</p>
          </div>
          ` : ''}
        `;
      }
      
      lucide.createIcons();
    }

    // Initialize on load
    init();
  </script>

</body>
</html>

