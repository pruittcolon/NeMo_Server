name: ci

on:
  pull_request:
  push:
    branches:
      - main

jobs:
  # Quick code validation (runs on every push)
  code-validation:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install test dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      - name: Run unit and smoke tests
        run: |
          pytest -m "unit or smoke or security" -v --maxfail=1

  # Integration tests (requires server startup)
  integration-tests:
    runs-on: ubuntu-latest
    if: ${{ contains(github.event.pull_request.labels.*.name, 'run-integration') }}
    needs: code-validation
    env:
      RUN_INTEGRATION: 1
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ffmpeg libsndfile1 sox
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      - name: Run integration tests (requires running services)
        env:
          GATEWAY_URL: http://localhost:8000
        run: |
          pytest -m integration -v --maxfail=1
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: integration-test-logs
          path: logs/

  # GPU tests (only runs on self-hosted runner with GPU)
  # To enable: Add a self-hosted runner with GPU and label it 'gpu'
  gpu-tests:
    runs-on: self-hosted
    if: ${{ contains(github.event.pull_request.labels.*.name, 'test-gpu') }}
    needs: code-validation
    steps:
      - uses: actions/checkout@v4
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r tests/requirements.txt
      - name: Verify GPU availability
        run: |
          nvidia-smi
      - name: Run test suite (no integration)
        env:
          RUN_INTEGRATION: 0
        run: |
          pytest -m "unit or smoke or security" -v --maxfail=1
      - name: Upload GPU test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: gpu-test-logs
          path: logs/
